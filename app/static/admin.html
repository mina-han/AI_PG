<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>관리자 대시보드 - 솔리아 (SOL-IA)</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #0f172a;
      color: #e2e8f0;
      padding: 20px;
      line-height: 1.6;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }
    
    header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 30px;
      border-radius: 12px;
      margin-bottom: 30px;
      box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3);
    }
    
    h1 {
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 8px;
    }
    
    .subtitle {
      font-size: 16px;
      opacity: 0.9;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .stat-card {
      background: #1e293b;
      padding: 24px;
      border-radius: 12px;
      border: 1px solid #334155;
      transition: all 0.3s ease;
    }
    
    .stat-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.4);
      border-color: #667eea;
    }
    
    .stat-label {
      font-size: 14px;
      color: #94a3b8;
      margin-bottom: 8px;
    }
    
    .stat-value {
      font-size: 36px;
      font-weight: 700;
      color: #667eea;
    }
    
    .stat-sub {
      font-size: 12px;
      color: #64748b;
      margin-top: 8px;
    }
    
    .success { color: #10b981; }
    .danger { color: #ef4444; }
    .warning { color: #f59e0b; }
    .info { color: #3b82f6; }
    
    .section {
      background: #1e293b;
      padding: 24px;
      border-radius: 12px;
      border: 1px solid #334155;
      margin-bottom: 20px;
    }
    
    .section-title {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 16px;
      color: #f1f5f9;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .refresh-btn {
      background: #667eea;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.2s;
      margin-left: auto;
    }
    
    .refresh-btn:hover {
      background: #5568d3;
      transform: scale(1.05);
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 16px;
    }
    
    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #334155;
    }
    
    th {
      background: #0f172a;
      font-weight: 600;
      color: #94a3b8;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    tr:hover {
      background: #2d3a4f;
    }
    
    .badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .badge-success { background: #10b98133; color: #10b981; }
    .badge-danger { background: #ef444433; color: #ef4444; }
    .badge-warning { background: #f59e0b33; color: #f59e0b; }
    .badge-info { background: #3b82f633; color: #3b82f6; }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: #64748b;
    }
    
    .chart-container {
      background: #0f172a;
      padding: 20px;
      border-radius: 8px;
      margin-top: 16px;
      min-height: 200px;
    }
    
    .bar-chart {
      display: flex;
      align-items: flex-end;
      gap: 8px;
      height: 150px;
    }
    
    .bar {
      flex: 1;
      background: #667eea;
      border-radius: 4px 4px 0 0;
      position: relative;
      transition: all 0.3s;
    }
    
    .bar:hover {
      background: #5568d3;
    }
    
    .bar-label {
      position: absolute;
      bottom: -24px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 11px;
      color: #64748b;
      white-space: nowrap;
    }
    
    .bar-value {
      position: absolute;
      top: -20px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 12px;
      font-weight: 600;
      color: #667eea;
    }
    
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #64748b;
    }
    
    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }
    
    @media (max-width: 768px) {
      .stats-grid {
        grid-template-columns: 1fr;
      }
      
      table {
        font-size: 12px;
      }
      
      th, td {
        padding: 8px;
      }
      
      .stat-value {
        font-size: 28px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>🛡️ 관리자 대시보드</h1>
      <p class="subtitle">솔리아 (SOL-IA) 시스템 모니터링 및 통계</p>
    </header>

    <!-- 주요 통계 -->
    <div class="stats-grid" id="statsGrid">
      <div class="loading">데이터 로딩 중...</div>
    </div>

    <!-- 시간대별 트래픽 -->
    <div class="section">
      <div class="section-title">
        📈 시간대별 트래픽 (최근 24시간)
        <button class="refresh-btn" onclick="loadData()">새로고침</button>
      </div>
      <div class="chart-container">
        <div class="bar-chart" id="trafficChart">
          <div class="loading">데이터 로딩 중...</div>
        </div>
      </div>
    </div>

    <!-- 프로바이더 통계 -->
    <div class="section">
      <div class="section-title">📞 프로바이더별 통계</div>
      <div id="providerStats">
        <div class="loading">데이터 로딩 중...</div>
      </div>
    </div>

    <!-- 최근 인시던트 -->
    <div class="section">
      <div class="section-title">🔔 최근 인시던트 (최대 50개)</div>
      <div id="recentIncidents">
        <div class="loading">데이터 로딩 중...</div>
      </div>
    </div>
  </div>

  <script>
    // 데이터 로드
    async function loadData() {
      await Promise.all([
        loadStats(),
        loadTraffic(),
        loadProviderStats(),
        loadRecentIncidents()
      ]);
    }

    // 통계 로드
    async function loadStats() {
      try {
        const response = await fetch('/admin/stats');
        const data = await response.json();
        
        const statsHTML = `
          <div class="stat-card">
            <div class="stat-label">총 인시던트</div>
            <div class="stat-value">${data.total_incidents}</div>
            <div class="stat-sub">오늘: ${data.today_incidents}건</div>
          </div>
          
          <div class="stat-card">
            <div class="stat-label">총 통화 시도</div>
            <div class="stat-value">${data.total_calls}</div>
            <div class="stat-sub success">성공: ${data.successful_calls}건</div>
          </div>
          
          <div class="stat-card">
            <div class="stat-label">성공률</div>
            <div class="stat-value ${data.success_rate >= 70 ? 'success' : data.success_rate >= 40 ? 'warning' : 'danger'}">${data.success_rate}%</div>
            <div class="stat-sub">실패: ${data.failed_calls}건</div>
          </div>
          
          <div class="stat-card">
            <div class="stat-label">평균 통화 시간</div>
            <div class="stat-value info">${data.avg_duration_sec}초</div>
            <div class="stat-sub">응답까지 평균 시간</div>
          </div>
          
          <div class="stat-card">
            <div class="stat-label">호전환 요청</div>
            <div class="stat-value warning">${data.dtmf_transfer_count}</div>
            <div class="stat-sub">키패드 1번 입력</div>
          </div>
          
          <div class="stat-card">
            <div class="stat-label">문자 전송 요청</div>
            <div class="stat-value info">${data.dtmf_sms_count}</div>
            <div class="stat-sub">키패드 2번 입력</div>
          </div>
        `;
        
        document.getElementById('statsGrid').innerHTML = statsHTML;
      } catch (error) {
        console.error('Failed to load stats:', error);
        document.getElementById('statsGrid').innerHTML = '<div class="empty-state"><div class="empty-state-icon">⚠️</div><p>통계를 불러오는데 실패했습니다</p></div>';
      }
    }

    // 시간대별 트래픽 로드
    async function loadTraffic() {
      try {
        const response = await fetch('/admin/hourly-traffic');
        const data = await response.json();
        
        if (data.length === 0) {
          document.getElementById('trafficChart').innerHTML = '<div class="empty-state"><div class="empty-state-icon">📊</div><p>최근 24시간 데이터가 없습니다</p></div>';
          return;
        }
        
        const maxCount = Math.max(...data.map(d => d.count));
        
        const barsHTML = data.map(d => {
          const height = (d.count / maxCount) * 100;
          const date = new Date(d.hour);
          const label = date.getHours() + ':00';
          
          return `
            <div class="bar" style="height: ${height}%;">
              <div class="bar-value">${d.count}</div>
              <div class="bar-label">${label}</div>
            </div>
          `;
        }).join('');
        
        document.getElementById('trafficChart').innerHTML = barsHTML;
      } catch (error) {
        console.error('Failed to load traffic:', error);
        document.getElementById('trafficChart').innerHTML = '<div class="empty-state">트래픽 데이터를 불러오는데 실패했습니다</div>';
      }
    }

    // 프로바이더 통계 로드
    async function loadProviderStats() {
      try {
        const response = await fetch('/admin/provider-stats');
        const data = await response.json();
        
        if (Object.keys(data).length === 0) {
          document.getElementById('providerStats').innerHTML = '<div class="empty-state"><div class="empty-state-icon">📞</div><p>프로바이더 데이터가 없습니다</p></div>';
          return;
        }
        
        const statsHTML = Object.entries(data).map(([provider, stats]) => `
          <div class="stat-card" style="margin-bottom: 12px;">
            <div class="stat-label">${provider.toUpperCase()}</div>
            <div class="stat-value">${stats.total}</div>
            <div class="stat-sub">
              <span class="success">성공: ${stats.successful}건</span> · 
              <span class="${stats.success_rate >= 70 ? 'success' : stats.success_rate >= 40 ? 'warning' : 'danger'}">성공률: ${stats.success_rate}%</span>
            </div>
          </div>
        `).join('');
        
        document.getElementById('providerStats').innerHTML = `<div class="stats-grid">${statsHTML}</div>`;
      } catch (error) {
        console.error('Failed to load provider stats:', error);
        document.getElementById('providerStats').innerHTML = '<div class="empty-state">프로바이더 통계를 불러오는데 실패했습니다</div>';
      }
    }

    // 최근 인시던트 로드
    async function loadRecentIncidents() {
      try {
        const response = await fetch('/admin/recent-incidents?limit=50');
        const data = await response.json();
        
        if (data.length === 0) {
          document.getElementById('recentIncidents').innerHTML = '<div class="empty-state"><div class="empty-state-icon">🔔</div><p>인시던트가 없습니다</p></div>';
          return;
        }
        
        const tableHTML = `
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>요약</th>
                <th>상태</th>
                <th>시도</th>
                <th>통화 결과</th>
                <th>생성 시간</th>
              </tr>
            </thead>
            <tbody>
              ${data.map(inc => {
                const statusBadge = inc.status === 'ack' ? 'badge-success' : 'badge-warning';
                const statusText = inc.status === 'ack' ? '확인됨' : '대기중';
                
                const callResults = inc.calls.map(call => {
                  let badge = 'badge-danger';
                  let text = call.result;
                  if (call.result === 'answered' || call.result === 'ack') {
                    badge = 'badge-success';
                    text = '성공';
                  } else if (call.result === 'no_answer') {
                    text = '무응답';
                  }
                  
                  return `<span class="badge ${badge}">${text}</span>`;
                }).join(' ');
                
                const createdAt = new Date(inc.created_at).toLocaleString('ko-KR');
                
                return `
                  <tr>
                    <td>#${inc.id}</td>
                    <td>${inc.summary}</td>
                    <td><span class="badge ${statusBadge}">${statusText}</span></td>
                    <td>${inc.attempts}</td>
                    <td>${callResults || '-'}</td>
                    <td>${createdAt}</td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        `;
        
        document.getElementById('recentIncidents').innerHTML = tableHTML;
      } catch (error) {
        console.error('Failed to load recent incidents:', error);
        document.getElementById('recentIncidents').innerHTML = '<div class="empty-state">인시던트 목록을 불러오는데 실패했습니다</div>';
      }
    }

    // 페이지 로드 시 데이터 로드
    loadData();
    
    // 30초마다 자동 새로고침
    setInterval(loadData, 30000);
  </script>
</body>
</html>

