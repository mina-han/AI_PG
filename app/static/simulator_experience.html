<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5, user-scalable=yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <title>AI ì¸í”„ë¼ë¹„ì„œ ì¥ì• ì•Œë¦¼ì²´í—˜</title>
  <style>
    :root{
      --bg: #f0f7ff;
      --card: #ffffff;
      --ink: #0f172a;
      --muted:#475569;
      --primary:#0046ff;
      --primary-2:#0033cc;
      --accent:#22c55e;
      --border:#d1e3f8;
      --warning:#ef4444;
      --warning-bg:#fff5f5;
      --warning-border:#fecaca;
      --shinhan-blue:#0046ff;
      --shinhan-light:#e6f0ff;
    }
    *{box-sizing:border-box}
    html,body{height:100%;-webkit-text-size-adjust:100%}
    body{margin:0;background:linear-gradient(180deg,#e6f0ff,#ffffff);font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Apple Color Emoji,Noto Color Emoji; color:var(--ink);overflow-x:hidden}
    .container{max-width:1100px;margin:0 auto;padding:16px}
    h1{margin:0;font-size:24px;color:var(--shinhan-blue)}
    .sub{color:var(--muted);font-size:13px;margin-top:6px}
    .brand{display:inline-block;padding:4px 12px;background:var(--shinhan-blue);color:#fff;border-radius:6px;font-size:12px;font-weight:700;margin-bottom:8px}
    
    @media(min-width:768px){
      .container{padding:24px}
      h1{font-size:28px}
      .sub{font-size:14px}
    }
    
    /* Alert Box */
    .alert-box{
      background:linear-gradient(135deg, #e6f0ff 0%, #f0f7ff 100%);
      border:2px solid var(--shinhan-blue);
      border-radius:12px;
      padding:16px;
      margin:16px 0;
      box-shadow:0 4px 12px rgba(0,70,255,0.1);
    }
    .alert-box h2{
      margin:0 0 10px;
      font-size:16px;
      color:var(--shinhan-blue);
      display:flex;
      align-items:center;
      gap:8px;
      font-weight:700;
    }
    .alert-box p{
      margin:6px 0;
      line-height:1.5;
      font-size:14px;
    }
    .alert-box .note{
      font-size:11px;
      color:var(--shinhan-blue);
      font-weight:600;
      margin-top:10px;
      background:#fff;
      padding:8px 10px;
      border-radius:8px;
      border-left:3px solid var(--shinhan-blue);
      line-height:1.5;
    }
    
    @media(min-width:768px){
      .alert-box{
        border-radius:16px;
        padding:20px;
        margin:24px 0;
      }
      .alert-box h2{
        font-size:18px;
        margin-bottom:12px;
      }
      .alert-box p{
        margin:8px 0;
        line-height:1.6;
      }
      .alert-box .note{
        font-size:12px;
        padding:8px 12px;
        margin-top:12px;
      }
    }
    
    /* User Input Form */
    .user-form{
      background:rgba(255,255,255,.9);
      backdrop-filter:saturate(120%) blur(2px);
      border:1px solid var(--border);
      border-radius:16px;
      padding:16px;
      margin:16px 0;
    }
    .user-form h3{
      margin:0 0 12px;
      font-size:15px;
    }
    .form-group{
      margin-bottom:14px;
    }
    .form-group label{
      display:block;
      font-size:13px;
      font-weight:600;
      margin-bottom:6px;
      color:var(--ink);
    }
    .form-group input{
      width:100%;
      padding:14px 16px;
      border:1px solid var(--border);
      border-radius:10px;
      font-size:16px;
      font-family:inherit;
      -webkit-appearance:none;
      appearance:none;
    }
    .form-group input:focus{
      outline:none;
      border-color:var(--primary);
      box-shadow:0 0 0 3px rgba(79,70,229,0.1);
    }
    .form-group .hint{
      font-size:11px;
      color:var(--muted);
      margin-top:4px;
      line-height:1.4;
    }
    
    @media(min-width:768px){
      .user-form{
        border-radius:22px;
        padding:24px;
        margin:24px 0;
      }
      .user-form h3{
        font-size:16px;
        margin-bottom:16px;
      }
      .form-group{
        margin-bottom:16px;
      }
      .form-group label{
        font-size:14px;
      }
      .form-group input{
        padding:10px 14px;
        font-size:14px;
        border-radius:12px;
      }
      .form-group .hint{
        font-size:12px;
      }
    }
    
    .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:16px}
    .btn{
      border:1px solid var(--border);
      background:#fff;
      padding:14px 20px;
      border-radius:10px;
      font-size:15px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      font-weight:600;
      min-height:48px;
      flex:1;
      white-space:nowrap;
      -webkit-tap-highlight-color:transparent;
    }
    .btn.primary{
      background:var(--primary);
      color:#fff;
      border-color:var(--primary);
      box-shadow:0 2px 8px rgba(0,70,255,0.2);
    }
    .btn.primary:active{background:var(--primary-2)}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    select{
      padding:12px 14px;
      border-radius:10px;
      border:1px solid var(--border);
      font-size:14px;
      background:#fff;
      min-height:48px;
      -webkit-appearance:none;
      appearance:none;
    }
    
    @media(min-width:768px){
      .controls{gap:12px}
      .btn{
        padding:10px 16px;
        border-radius:12px;
        font-size:14px;
        min-height:auto;
        flex:initial;
      }
      .btn.primary{box-shadow:none}
      .btn.primary:hover{background:var(--primary-2)}
      select{
        padding:8px 12px;
        border-radius:12px;
        min-height:auto;
      }
    }
    
    .grid{display:grid;grid-template-columns:1fr;gap:12px;margin-top:16px}
    @media(min-width:960px){.grid{grid-template-columns:1fr 1fr;gap:16px;margin-top:20px}}
    
    .panel{
      background:rgba(255,255,255,.8);
      backdrop-filter:saturate(120%) blur(2px);
      border:1px solid var(--border);
      border-radius:16px;
      padding:14px;
    }
    .panel h3{
      margin:0 0 10px;
      font-size:15px;
      display:flex;
      align-items:center;
      gap:6px;
    }
    
    @media(min-width:768px){
      .panel{
        border-radius:22px;
        padding:18px;
      }
      .panel h3{
        font-size:16px;
        margin-bottom:12px;
        gap:8px;
      }
    }
    
    .steps{
      display:flex;
      flex-direction:column;
      gap:6px;
      max-height:400px;
      overflow-y:auto;
      overflow-x:hidden;
      padding:2px;
      -webkit-overflow-scrolling:touch;
      scroll-behavior:smooth;
    }
    
    /* ìŠ¤í¬ë¡¤ë°” ìŠ¤íƒ€ì¼ */
    .steps::-webkit-scrollbar{
      width:6px;
    }
    .steps::-webkit-scrollbar-track{
      background:rgba(0,0,0,0.05);
      border-radius:10px;
    }
    .steps::-webkit-scrollbar-thumb{
      background:rgba(0,70,255,0.3);
      border-radius:10px;
    }
    .steps::-webkit-scrollbar-thumb:hover{
      background:rgba(0,70,255,0.5);
    }
    .step{
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px 12px;
      display:flex;
      align-items:flex-start;
      gap:10px;
      background:#fff;
      position:relative;
    }
    .step.active{background:linear-gradient(90deg,#e6f0ff,#f0f7ff);border-color:#0046ff;box-shadow:0 2px 8px rgba(0,70,255,0.12)}
    .step.done{background:linear-gradient(90deg,#ecfdf5,#f0fdf4);border-color:#6ee7b7}
    .step.skipped{opacity:.6}
    .dot{width:16px;height:16px;border-radius:50%;background:#cbd5e1;flex:0 0 auto;margin-top:2px}
    .step.active .dot{background:#0046ff;animation:pulse 1s infinite}
    .step.done .dot{background:#22c55e}
    @keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.15)}100%{transform:scale(1)}}
    .title{font-weight:600;font-size:13px;line-height:1.4}
    .subtxt{font-size:11px;color:var(--muted);margin-top:4px;line-height:1.3}
    .divider{width:2px;height:12px;background:linear-gradient(#e2e8f0,transparent);margin:4px auto}
    
    @media(min-width:768px){
      .steps{
        gap:8px;
        max-height:500px;
      }
      .step{
        border-radius:18px;
        padding:12px 14px;
        gap:12px;
      }
      .step.active{box-shadow:0 4px 10px rgba(0,70,255,0.12)}
      .dot{width:18px;height:18px}
      .title{font-size:14px}
      .subtxt{font-size:12px}
      .divider{height:16px;margin:8px auto}
    }
    
    .logs{
      background:#001a4d;
      color:#e5e7eb;
      border-radius:12px;
      border:2px solid #0046ff;
      height:300px;
      overflow:auto;
      padding:12px;
      font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size:11px;
      white-space:pre-wrap;
      line-height:1.5;
      -webkit-overflow-scrolling:touch;
    }
    
    @media(min-width:768px){
      .logs{
        border-radius:18px;
        height:450px;
        padding:14px;
        font-size:12px;
      }
    }
    
    @media(min-width:960px){
      .logs{height:540px}
    }
    
    .logline{line-height:1.6}
    .logtag{color:#6bb3ff}
    .muted{color:var(--muted);font-size:11px}
    footer{margin:20px 0 16px;text-align:center;color:#94a3b8;font-size:11px;line-height:1.5}
    .desktop-footer{display:none}
    .mobile-footer{display:block}
    .icon{width:16px;height:16px}
    .error-msg{color:#ef4444;font-size:12px;margin-top:8px;display:none;line-height:1.4}
    
    @media(min-width:768px){
      .muted{font-size:12px}
      footer{margin:28px 0;font-size:12px}
      .desktop-footer{display:block}
      .mobile-footer{display:none}
      .icon{width:18px;height:18px}
      .error-msg{font-size:13px}
    }
  </style>
</head>
<body>
  <div class="container">
    <span class="brand">SHINHAN DS</span>
    <h1>AI ì¸í”„ë¼ë¹„ì„œ ì¥ì• ì•Œë¦¼ì²´í—˜</h1>
    <div class="sub">ì‹¤ì œ ê¸´ê¸‰ ì¥ì•  ì•Œë¦¼ ì‹œìŠ¤í…œì„ ì²´í—˜í•´ë³´ì„¸ìš”. <a href="/static/index.html" style="color:#667eea;text-decoration:none;font-weight:600">â† ë©”ì¸ìœ¼ë¡œ</a></div>

    <div class="alert-box">
      <h2>
        <svg class="icon" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
        </svg>
        ê¸´ê¸‰ ìƒí™© ë°œìƒ
      </h2>
      <p><strong>ë‹¹ì‹ ì€ ì‹ í•œDS ì„œë²„ ë‹´ë‹¹ìì…ë‹ˆë‹¤.</strong></p>
      <p>ê¸´ê¸‰ ì¥ì• ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì•„ë˜ ì •ë³´ë¥¼ ì…ë ¥í•˜ì—¬ ì‹œë®¬ë ˆì´ì…˜ì„ ì‹œì‘í•´ì£¼ì„¸ìš”.</p>
      <p class="note">ğŸ’¡ ë‹´ë‹¹ì ì •ë³´ì™€ ì¥ì•  ë©”ì‹œì§€ë¥¼ ì›í•˜ëŠ” ëŒ€ë¡œ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (ê¸°ë³¸ê°’: ë‹¨ìœ„DB ì„œë²„ ë‹¤ìš´ Critical)</p>
      
      <div style="background:#ffebee;border:2px solid #f44336;border-radius:10px;padding:12px;margin:16px 0;text-align:center;">
        <span style="font-size:18px;">ğŸ“</span>
        <strong style="color:#c62828;font-size:14px;margin-left:8px;">í•´ì™¸ ì „í™”(+1507...)ë¡œ ì˜µë‹ˆë‹¤. ìŠ¤íŒ¸ ì•„ë‹ˆë‹ˆ ê¼­ ë°›ìœ¼ì„¸ìš”!</strong>
      </div>
      
      <div style="background:#e8f5e9;border:1px solid #66bb6a;border-radius:10px;padding:14px;margin-bottom:20px">
        <h4 style="margin:0 0 10px;font-size:13px;color:#2e7d32;font-weight:700">ğŸ”„ ìˆœì°¨ ì—ìŠ¤ì»¬ë ˆì´ì…˜ ë°©ì‹</h4>
        <div style="font-size:12px;color:#1b5e20;line-height:1.6;">
          <div style="margin-bottom:8px;">
            <strong>ğŸ“‹ ì •ë‹´ë‹¹ì + ë¶€ë‹´ë‹¹ì ì…ë ¥ ì‹œ:</strong><br>
            <span style="color:#424242;">ì •ë‹´ë‹¹ì(1ì°¨) â†’ ë¶€ë‹´ë‹¹ì(1ì°¨) â†’ ì •ë‹´ë‹¹ì(2ì°¨) â†’ ë¶€ë‹´ë‹¹ì(2ì°¨)</span><br>
            <span style="font-size:11px;color:#666;">â€» ìµœëŒ€ 4íšŒ ì‹œë„, í•œ ëª…ì´ë¼ë„ ë°›ìœ¼ë©´ ì¦‰ì‹œ ì¢…ë£Œ</span>
          </div>
          <div style="margin-bottom:8px;">
            <strong>ğŸ“‹ ì •ë‹´ë‹¹ìë§Œ ì…ë ¥ ì‹œ:</strong><br>
            <span style="color:#424242;">ì •ë‹´ë‹¹ì(1ì°¨) â†’ ì •ë‹´ë‹¹ì(2ì°¨)</span><br>
            <span style="font-size:11px;color:#666;">â€» ìµœëŒ€ 2íšŒ ì‹œë„, ë°›ìœ¼ë©´ ì¦‰ì‹œ ì¢…ë£Œ</span>
          </div>
          <div style="background:#fff3cd;border:1px solid #ffc107;border-radius:6px;padding:10px;margin-top:12px;">
            <strong style="color:#856404;">ğŸ“ ìƒí™©ê·¼ë¬´ì í˜¸ì „í™˜ ê¸°ëŠ¥:</strong><br>
            <span style="color:#856404;">ì „í™” ìˆ˜ì‹  ì¤‘ <strong>í‚¤íŒ¨ë“œ 1ë²ˆ</strong>ì„ ëˆ„ë¥´ë©´ ìƒí™©ê·¼ë¬´ì(010-8672-1718)ì—ê²Œ ì¦‰ì‹œ ì—°ê²°ë©ë‹ˆë‹¤.</span><br>
            <span style="font-size:11px;color:#856404;">â€» ì½œë“œ ì „í™˜ ë°©ì‹: ë‹´ë‹¹ì â†” ìƒí™©ê·¼ë¬´ì ì§ì ‘ í†µí™”</span>
          </div>
        </div>
      </div>
    </div>

    <div class="user-form">
      <h3>ë‹´ë‹¹ì ì •ë³´ ì…ë ¥</h3>
      
      <div style="background:linear-gradient(135deg, #e6f0ff 0%, #f0f7ff 100%);border:2px solid #0046ff;border-radius:10px;padding:14px;margin-bottom:16px;box-shadow:0 2px 8px rgba(0,70,255,0.08)">
        <h4 style="margin:0 0 10px;font-size:13px;color:#0046ff;font-weight:700">ì •ë‹´ë‹¹ì (Primary Contact)</h4>
        <div class="form-group" style="margin-bottom:12px">
          <label for="primaryName">ì„±ëª…</label>
          <input type="text" id="primaryName" placeholder="í™ê¸¸ë™" />
          <div class="hint">ì •ë‹´ë‹¹ì ì„±ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.</div>
        </div>
        <div class="form-group" style="margin-bottom:0">
          <label for="primaryPhone">íœ´ëŒ€í° ë²ˆí˜¸</label>
          <input type="tel" id="primaryPhone" placeholder="01012345678" maxlength="13" class="phone-input" />
          <div class="hint">ìˆ«ìë§Œ ì…ë ¥í•˜ì„¸ìš” (í•˜ì´í”ˆ ìë™ ì¶”ê°€)</div>
        </div>
      </div>
      
      <div style="background:#f0f7ff;border:1px solid #a7c7ff;border-radius:10px;padding:14px;position:relative;margin-bottom:16px">
        <h4 style="margin:0 0 10px;font-size:13px;color:#0046ff">ë¶€ë‹´ë‹¹ì (Secondary) <span style="color:#94a3b8;font-size:11px;font-weight:400">- ì„ íƒ</span></h4>
        <div class="form-group" style="margin-bottom:12px">
          <label for="secondaryName">ì„±ëª… <span style="color:#94a3b8;font-weight:400">(ì„ íƒ)</span></label>
          <input type="text" id="secondaryName" placeholder="ê¹€ì² ìˆ˜ (ì„ íƒì‚¬í•­)" />
          <div class="hint">ë¶€ë‹´ë‹¹ìê°€ ìˆëŠ” ê²½ìš° ì…ë ¥í•´ì£¼ì„¸ìš”.</div>
        </div>
        <div class="form-group" style="margin-bottom:0">
          <label for="secondaryPhone">íœ´ëŒ€í° ë²ˆí˜¸ <span style="color:#94a3b8;font-weight:400">(ì„ íƒ)</span></label>
          <input type="tel" id="secondaryPhone" placeholder="01098765432 (ì„ íƒì‚¬í•­)" maxlength="13" class="phone-input" />
          <div class="hint">ìˆ«ìë§Œ ì…ë ¥í•˜ì„¸ìš” (í•˜ì´í”ˆ ìë™ ì¶”ê°€)</div>
        </div>
      </div>
      
      <div style="background:#fff9f0;border:1px solid #fbbf24;border-radius:10px;padding:14px;margin-bottom:16px">
        <h4 style="margin:0 0 10px;font-size:13px;color:#f59e0b;font-weight:700">ğŸ“ ì¥ì•  ë©”ì‹œì§€ ì„¤ì •</h4>
        <div class="form-group" style="margin-bottom:0">
          <label for="incidentMessage">ì¥ì•  ë©”ì‹œì§€</label>
          <input type="text" id="incidentMessage" value="ë‹¨ìœ„DB ì„œë²„ ë‹¤ìš´ Critical" />
          <div class="hint">ì „í™”ë¡œ ì „ë‹¬ë  ì¥ì•  ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</div>
        </div>
      </div>
      
      <div class="error-msg" id="errorMsg">ì •ë‹´ë‹¹ì ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</div>
    </div>

    <div class="controls">
      <button id="reset" class="btn">â†» ë¦¬ì…‹</button>
      <button id="start" class="btn primary">â–¶ ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘</button>
    </div>

    <div class="grid">
      <div class="panel">
        <h3>ê¸´ê¸‰ ì „íŒŒ ì›Œí¬í”Œë¡œìš°</h3>
        <div id="steps" class="steps"></div>
      </div>

      <div class="panel">
        <h3>ì‹¤ì‹œê°„ ì‹œë®¬ë ˆì´ì…˜ ë¡œê·¸</h3>
        <div id="logs" class="logs"><div class="muted">ì‹œë®¬ë ˆì´ì…˜ ë¡œê·¸ê°€ ì—¬ê¸°ì— ì¶œë ¥ë©ë‹ˆë‹¤â€¦</div></div>
      </div>
    </div>

    <footer>
      <div class="desktop-footer">Â© <span id="year"></span> SHINHAN DS Â· AI ì¸í”„ë¼ë¹„ì„œ ì¥ì• ì•Œë¦¼ì²´í—˜ Â· Demo Simulator</div>
      <div class="mobile-footer">Â© <span id="year2"></span> SHINHAN DS<br>AI ì¸í”„ë¼ë¹„ì„œ ì²´í—˜</div>
    </footer>
  </div>

<script>
(function(){
  const $ = (sel)=>document.querySelector(sel);
  const $$ = (sel)=>Array.from(document.querySelectorAll(sel));
  const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));

  const API_BASE_URL = window.location.origin;  // ë™ì ìœ¼ë¡œ í˜„ì¬ ì„œë²„ ì‚¬ìš©

  const STEPS_EMERGENCY = [
    { title:"START: ì´ë²¤íŠ¸ ìˆ˜ì‹  (NMS Webhook)"},
    { title:"ë¶„ì„ (Dify/LLM): ì‹œìŠ¤í…œëª…Â·ì¥ì• ë‚´ìš© ì¶”ì¶œ ë° ê¸´ê¸‰ì„± ì¬íŒë‹¨"},
    { title:"ì¡°ê±´ í™•ì¸: ì „í™” ë°œì†¡ ëŒ€ìƒì¸ê°€?"},
    { title:"ITSM ì—°ë™: ì˜¨ì½œ ë‹´ë‹¹ì ì¡°íšŒ"},
    { title:"PDS/TTS ì—°ë™: ê°œì¸í™” ìŒì„± í†µë³´"},
    { title:"í˜¸ì „í™˜ ê¸°ë¡ í™•ì¸: ìƒí™©ê·¼ë¬´ì ì—°ê²° ì—¬ë¶€"},
    { title:"Reporting: ê²°ê³¼ ê¸°ë¡"},
    { title:"END"}
  ];

  let running = false;
  let lines = [];
  let realCallMode = true;  // ì‹¤ì œ ì „í™” ëª¨ë“œ
  let startTime = null;  // ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘ ì‹œê°„

  const $steps = $("#steps");
  const $logs = $("#logs");
  const $start = $("#start");
  const $reset = $("#reset");
  const $primaryName = $("#primaryName");
  const $primaryPhone = $("#primaryPhone");
  const $secondaryName = $("#secondaryName");
  const $secondaryPhone = $("#secondaryPhone");
  const $incidentMessage = $("#incidentMessage");
  const $errorMsg = $("#errorMsg");

  // init
  const currentYear = new Date().getFullYear();
  $("#year").textContent = currentYear;
  if($("#year2")) $("#year2").textContent = currentYear;

  // Phone number formatting for all phone inputs
  function formatPhoneNumber(e){
    let val = e.target.value.replace(/[^0-9]/g, '');
    if(val.length <= 3) {
      e.target.value = val;
    } else if(val.length <= 7) {
      e.target.value = val.slice(0,3) + '-' + val.slice(3);
    } else if(val.length <= 11) {
      e.target.value = val.slice(0,3) + '-' + val.slice(3,7) + '-' + val.slice(7);
    } else {
      e.target.value = val.slice(0,3) + '-' + val.slice(3,7) + '-' + val.slice(7,11);
    }
  }
  
  $$('.phone-input').forEach(input => {
    input.oninput = formatPhoneNumber;
  });

  function renderSteps(){
    $steps.innerHTML = "";
    STEPS_EMERGENCY.forEach((s,i)=>{
      const el = document.createElement("div");
      el.className = "step";
      el.innerHTML = `<div class="dot"></div>
        <div><div class="title">${i+1}. ${s.title}</div>
        ${s.subtitle?`<div class="subtxt">${s.subtitle}</div>`:""}</div>`;
      $steps.appendChild(el);
      if(i<STEPS_EMERGENCY.length-1){ 
        const div = document.createElement("div"); 
        div.className="divider"; 
        $steps.appendChild(div); 
      }
    });
  }

  function setStepStatus(idx, status){
    const stepEls = $$(".step");
    const el = stepEls[idx];
    if(!el) return;
    el.classList.remove("idle","active","done","skipped");
    el.classList.add(status);
    
    // í™œì„±í™”ëœ ë‹¨ê³„ë¡œ ìŠ¤í¬ë¡¤ (ë¶€ë“œëŸ½ê²Œ)
    if(status === "active"){
      // ëª¨ë°”ì¼ì—ì„œëŠ” ë” ë¶€ë“œëŸ½ê²Œ, ë°ìŠ¤í¬í†±ì—ì„œëŠ” ì¦‰ì‹œ
      const isMobile = window.innerWidth < 768;
      setTimeout(() => {
        el.scrollIntoView({ 
          behavior: 'smooth', 
          block: isMobile ? 'center' : 'nearest',
          inline: 'nearest'
        });
      }, isMobile ? 100 : 50);
    }
  }

  function pushLog(text, timestamp){
    if(lines.length===0) $logs.innerHTML = "";
    lines.push(text);
    const div = document.createElement("div");
    div.className="logline";
    const timeStr = timestamp ? ` <span style="color:#94a3b8;font-size:11px">[${timestamp}]</span>` : '';
    div.innerHTML = `<span class="logtag">[Step ${lines.length}]</span> ${text}${timeStr}`;
    $logs.appendChild(div);
    $logs.scrollTop = $logs.scrollHeight;
  }

  function reset(){
    running = false; 
    lines = [];
    renderSteps();
    $logs.innerHTML = '<div class="muted">ì‹œë®¬ë ˆì´ì…˜ ë¡œê·¸ê°€ ì—¬ê¸°ì— ì¶œë ¥ë©ë‹ˆë‹¤â€¦</div>';
    $errorMsg.style.display = 'none';
    
    // ì›Œí¬í”Œë¡œìš°ë¥¼ ë§¨ ìœ„ë¡œ ìŠ¤í¬ë¡¤
    if($steps){
      $steps.scrollTop = 0;
    }
  }

  function validateInputs(){
    const primaryName = $primaryName.value.trim();
    const primaryPhone = $primaryPhone.value.trim();
    const secondaryName = $secondaryName.value.trim();
    const secondaryPhone = $secondaryPhone.value.trim();
    const phoneRegex = /^010-\d{4}-\d{4}$/;
    
    // ì •ë‹´ë‹¹ìëŠ” í•„ìˆ˜
    if(!primaryName || !primaryPhone){
      $errorMsg.textContent = 'ì •ë‹´ë‹¹ì ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.';
      $errorMsg.style.display = 'block';
      return false;
    }
    
    if(!phoneRegex.test(primaryPhone)){
      $errorMsg.textContent = 'ì •ë‹´ë‹¹ì íœ´ëŒ€í° ë²ˆí˜¸ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. (ì˜ˆ: 010-1234-5678)';
      $errorMsg.style.display = 'block';
      return false;
    }
    
    // ë¶€ë‹´ë‹¹ìëŠ” ì„ íƒì‚¬í•­ì´ì§€ë§Œ, ì…ë ¥í–ˆë‹¤ë©´ ìœ íš¨ì„± ê²€ì‚¬
    if(secondaryName || secondaryPhone){
      if(!secondaryName || !secondaryPhone){
        $errorMsg.textContent = 'ë¶€ë‹´ë‹¹ì ì •ë³´ë¥¼ ì…ë ¥í•˜ë ¤ë©´ ì„±ëª…ê³¼ íœ´ëŒ€í° ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.';
        $errorMsg.style.display = 'block';
        return false;
      }
      
      if(!phoneRegex.test(secondaryPhone)){
        $errorMsg.textContent = 'ë¶€ë‹´ë‹¹ì íœ´ëŒ€í° ë²ˆí˜¸ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. (ì˜ˆ: 010-1234-5678)';
        $errorMsg.style.display = 'block';
        return false;
      }
      
      if(primaryPhone === secondaryPhone){
        $errorMsg.textContent = 'ì •ë‹´ë‹¹ìì™€ ë¶€ë‹´ë‹¹ìì˜ íœ´ëŒ€í° ë²ˆí˜¸ê°€ ë™ì¼í•©ë‹ˆë‹¤. ë‹¤ë¥¸ ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.';
        $errorMsg.style.display = 'block';
        return false;
      }
    }
    
    $errorMsg.style.display = 'none';
    return true;
  }

  // ì „í™”ë²ˆí˜¸ í˜•ì‹ ë³€í™˜ (010-1234-5678 â†’ +821012345678)
  function convertToE164(phone) {
    if(!phone) return null;
    // 010-1234-5678 â†’ +821012345678
    return '+82' + phone.replace(/^0/, '').replace(/-/g, '');
  }

  // ë¡œê·¸ ë¼ì¸ì„ ì—…ë°ì´íŠ¸ (ê¸°ì¡´ ë¼ì¸ ìˆ˜ì •)
  function updateLastLog(text, timestamp){
    const logLines = $$(".logline");
    if(logLines.length > 0){
      const lastLine = logLines[logLines.length - 1];
      const currentStepNumber = lines.length;
      const timeStr = timestamp ? ` <span style="color:#94a3b8;font-size:11px">[${timestamp}]</span>` : '';
      lastLine.innerHTML = `<span class="logtag">[Step ${currentStepNumber}]</span> ${text}${timeStr}`;
      // lines ë°°ì—´ì˜ ë§ˆì§€ë§‰ í•­ëª©ë„ ì—…ë°ì´íŠ¸
      lines[lines.length - 1] = text;
    }
  }

      async function callRealAPI(primaryName, primaryPhone, secondaryName, secondaryPhone, incidentMessage){
    return new Promise((resolve, reject) => {
      try {
        const payload = {
          primary_name: primaryName,
          primary_phone: convertToE164(primaryPhone),
          secondary_name: secondaryName || null,
          secondary_phone: secondaryPhone ? convertToE164(secondaryPhone) : null,
          incident_summary: incidentMessage,
          tts_text: `ê¸´ê¸‰ ìƒí™©ì…ë‹ˆë‹¤. ${incidentMessage} ì¥ì• ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì¦‰ì‹œ í™•ì¸í•´ ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.`
        };
        
        // "API ì—°ê²° ì¤‘..." ë¡œê·¸ ì œê±° (ìš”ì²­ì‚¬í•­ 4ë²ˆ)
        
        const eventSource = new EventSource(`${API_BASE_URL}/simulator/call`);
        let callResults = [];
        let completed = false;
        const callSidRef = { value: null };  // CallSidë¥¼ ì €ì¥í•  ê°ì²´ (ì°¸ì¡° ì „ë‹¬ìš©)
        
        // POST ë°ì´í„°ë¥¼ ì „ì†¡í•˜ê¸° ìœ„í•´ fetch ì‚¬ìš©
        fetch(`${API_BASE_URL}/simulator/call`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'text/event-stream'
          },
          body: JSON.stringify(payload)
        }).then(response => {
          if(!response.ok){
            throw new Error(`API ì˜¤ë¥˜: ${response.status}`);
          }
          
          const reader = response.body.getReader();
          const decoder = new TextDecoder();
          
          function readStream(){
            reader.read().then(({done, value}) => {
              if(done){
                if(!completed){
                  pushLog("ğŸ”” ì „í™” ë°œì‹  í”„ë¡œì„¸ìŠ¤ ì™„ë£Œ");
                  resolve({success: true, calls: callResults});
                }
                return;
              }
              
              const text = decoder.decode(value);
              const lines = text.split('\n');
              
              for(const line of lines){
                if(line.startsWith('data: ')){
                  try {
                    const data = JSON.parse(line.substring(6));
                    handleSSEEvent(data, callResults, callSidRef);
                    
                    if(data.type === 'escalation_complete' || data.type === 'escalation_failed'){
                      completed = true;
                      // escalation_completeëŠ” ì„±ê³µ, escalation_failedëŠ” ì‹¤íŒ¨
                      const isSuccess = data.type === 'escalation_complete';
                      resolve({success: isSuccess, calls: callResults, callSid: callSidRef.value});
                      return;
                    }
                  } catch(e){
                    console.error('SSE parse error:', e);
                  }
                }
              }
              
            readStream();
          }).catch(async error => {
            // ë„¤íŠ¸ì›Œí¬ ëŠê¹€ ê°ì§€ (ì „í™” ìˆ˜ì‹  ì¤‘)
            if(!completed){
              // ëª¨ë°”ì¼ì—ì„œ ì „í™”ë¥¼ ë°›ìœ¼ë©´ ë„¤íŠ¸ì›Œí¬ê°€ ì „í™˜ë˜ì–´ ë¸Œë¼ìš°ì € ì—°ê²°ì´ ëŠê¹€
              // í†µí™”ê°€ ëë‚  ë•Œê¹Œì§€ ëŒ€ê¸° (ì•½ 60ì´ˆ)
              pushLog(`ğŸ“ í†µí™” ì¤‘ì…ë‹ˆë‹¤...`);
              
              // 60ì´ˆ ëŒ€ê¸° í›„ ì„±ê³µ ì²˜ë¦¬
              await new Promise(r => setTimeout(r, 60000));
              
              if(!completed){
                completed = true;
                pushLog(`âœ… ì „í™” ì—°ê²° ì„±ê³µ!`);
                resolve({success: true, calls: callResults, answered: true, callSid: callSidRef.value});
              }
            }
          });
          }
          
          readStream();
        }).catch(async error => {
          // ì „í™” ìˆ˜ì‹ ìœ¼ë¡œ ì¸í•œ ì—°ê²° ëŠê¹€ì¸ ê²½ìš°
          if(error.message.includes('Failed to fetch') || error.message.includes('NetworkError')){
            // í†µí™”ê°€ ëë‚  ë•Œê¹Œì§€ ëŒ€ê¸° (ì•½ 60ì´ˆ)
            pushLog(`ğŸ“ í†µí™” ì¤‘ì…ë‹ˆë‹¤...`);
            
            // 60ì´ˆ ëŒ€ê¸° í›„ ì„±ê³µ ì²˜ë¦¬
            await new Promise(r => setTimeout(r, 60000));
            
            pushLog(`âœ… ì „í™” ì—°ê²° ì„±ê³µ!`);
            resolve({success: true, calls: [], answered: true, callSid: callSidRef.value});
          } else {
            pushLog(`âš ï¸ API í˜¸ì¶œ ì‹¤íŒ¨: ${error.message}`);
            pushLog(`ğŸ’¡ ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”: ${API_BASE_URL}`);
            reject(error);
          }
        });
        
      } catch(error) {
        pushLog(`âš ï¸ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`);
        reject(error);
      }
    });
  }

  function handleSSEEvent(data, callResults, callSidRef){
    switch(data.type){
      case 'call_start':
        pushLog(`ğŸ“ ${data.role} ${data.name} (${data.phone}): ë°œì‹ ì¤‘...`, data.timestamp);
        break;
      
      case 'call_initiated':
        updateLastLog(`ğŸ“ ${data.role || 'ë‹´ë‹¹ì'}: í˜¸ì¶œ ì‹œì‘ (Call ID: ${data.call_id})`, data.timestamp);
        // CallSid ì €ì¥
        if(callSidRef && data.call_id) {
          callSidRef.value = data.call_id;
          console.log('[DEBUG] CallSid saved:', data.call_id);
        }
        break;
      
      case 'call_answered':
        updateLastLog(`âœ… ${data.name}: ì „í™” ì—°ê²° ì„±ê³µ! (í†µí™”ì‹œê°„: ${data.duration}ì´ˆ)`, data.timestamp);
        callResults.push({name: data.name, status: 'answered', duration: data.duration});
        break;
      
      case 'call_failed':
        updateLastLog(`âŒ ${data.name}: ì „í™” ì—°ê²° ì‹¤íŒ¨ (${data.reason})`, data.timestamp);
        callResults.push({name: data.name, status: 'failed', reason: data.reason});
        break;
      
      case 'call_error':
        updateLastLog(`âš ï¸ ${data.name}: ì˜¤ë¥˜ ë°œìƒ - ${data.error}`, data.timestamp);
        callResults.push({name: data.name, status: 'error', error: data.error});
        break;
      
      case 'escalation_complete':
        pushLog(`ğŸ‰ ì—ìŠ¤ì»¬ë ˆì´ì…˜ ì„±ê³µ: ${data.answered_by}ë‹˜ì´ ì „í™”ë¥¼ ë°›ì•˜ìŠµë‹ˆë‹¤.`, data.timestamp);
        pushLog(`   ì´ ì‹œë„ íšŸìˆ˜: ${data.total_attempts}íšŒ`);
        break;
      
      case 'escalation_failed':
        pushLog(`âš ï¸ ì—ìŠ¤ì»¬ë ˆì´ì…˜ ì‹¤íŒ¨: ëª¨ë“  ë‹´ë‹¹ìê°€ ì „í™”ë¥¼ ë°›ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.`, data.timestamp);
        pushLog(`   ì´ ì‹œë„ íšŸìˆ˜: ${data.total_attempts}íšŒ`);
        break;
      
      case 'error':
        pushLog(`âš ï¸ ì‹œìŠ¤í…œ ì˜¤ë¥˜: ${data.message}`, data.timestamp);
        break;
    }
  }

  async function runEmergency(){
    if(running) return;
    
    if(!validateInputs()) return;
    
    reset(); 
    running = true;
    startTime = Date.now();  // ì‹œì‘ ì‹œê°„ ê¸°ë¡
    
    // ëª¨ë°”ì¼ì—ì„œ ì›Œí¬í”Œë¡œìš° ì„¹ì…˜ìœ¼ë¡œ ë¶€ë“œëŸ½ê²Œ ìŠ¤í¬ë¡¤
    const isMobile = window.innerWidth < 768;
    if(isMobile){
      const gridSection = document.querySelector('.grid');
      if(gridSection){
        setTimeout(() => {
          gridSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 300);
      }
    }
    
    const primaryName = $primaryName.value.trim();
    const primaryPhone = $primaryPhone.value.trim();
    const secondaryName = $secondaryName.value.trim();
    const secondaryPhone = $secondaryPhone.value.trim();
    const incidentMessage = $incidentMessage.value.trim() || "ë‹¨ìœ„DB ì„œë²„ ë‹¤ìš´ Critical";

    // 0
    setStepStatus(0,"active");
    pushLog(`NMS Webhook ìˆ˜ì‹  â†’ ë“±ê¸‰: Critical | ë‚´ìš©: '${incidentMessage}'`);
    await sleep(400);
    setStepStatus(0,"done");

    // 1
    setStepStatus(1,"active");
    pushLog("AI ë¹„ì„œ(Dify/LLM) ë¶„ì„ ì‹œì‘â€¦");
    await sleep(300);
    pushLog("â€¢ ì‹œìŠ¤í…œëª… ì¶”ì¶œ: ë‹¨ìœ„DB ì„œë²„");
    await sleep(300);
    pushLog("â€¢ í•µì‹¬ ì¥ì•  ë‚´ìš©: ì„œë²„ ë‹¤ìš´");
    await sleep(300);
    pushLog(`â€¢ ì› ë“±ê¸‰: Critical (í‘œì¤€)`);
    await sleep(300);
    pushLog(`â€¢ ê¸´ê¸‰ì„± ì¬íŒë‹¨: ì „í™” ë°œì†¡ í•„ìš” (Critical ë“±ê¸‰)`);
    await sleep(400);
    setStepStatus(1,"done");

    // 2
    setStepStatus(2,"active");
    pushLog(`ì¡°ê±´ í™•ì¸: ì „í™” ë°œì†¡ ëŒ€ìƒ â†’ YES (ê¸´ê¸‰ ì „í™” ê²½ë¡œ ì„ íƒ)`);
    await sleep(400);
    setStepStatus(2,"done");

    // 3
    setStepStatus(3,"active"); 
    pushLog(`ITSM ì˜¨ì½œ ì¡°íšŒâ€¦ ì •ë‹´ë‹¹ì: ${primaryName} / ${primaryPhone}`);
    await sleep(300);
    if(secondaryName && secondaryPhone){
      pushLog(`ITSM ì˜¨ì½œ ì¡°íšŒâ€¦ ë¶€ë‹´ë‹¹ì: ${secondaryName} / ${secondaryPhone}`);
      await sleep(300);
    } else {
      pushLog(`ë¶€ë‹´ë‹¹ì: ë¯¸ì§€ì • (ì •ë‹´ë‹¹ìë§Œ ì•Œë¦¼ ë°œì†¡)`);
      await sleep(300);
    }
    setStepStatus(3,"done");
    
    // 4 - ì‹¤ì œ API í˜¸ì¶œ (ì‹¤ì‹œê°„ ì—ìŠ¤ì»¬ë ˆì´ì…˜)
    setStepStatus(4,"active"); 
    pushLog(`[ì‹¤ì œ ì „í™” ë°œì‹ ] ìˆœì°¨ ì—ìŠ¤ì»¬ë ˆì´ì…˜ ì‹œì‘`);
    await sleep(300);
    
    let apiResult = null;
    let callSuccess = false;
    try {
      // SSEë¡œ ì‹¤ì‹œê°„ ë¡œê·¸ê°€ ìë™ ì¶œë ¥ë¨
      // callRealAPI ë‚´ë¶€ì—ì„œ ë„¤íŠ¸ì›Œí¬ ëŠê¹€ë„ ì²˜ë¦¬í•¨
      apiResult = await callRealAPI(primaryName, primaryPhone, secondaryName, secondaryPhone, incidentMessage);
      
      if(apiResult && apiResult.success){
        callSuccess = true;
        await sleep(300);
      } else {
        pushLog("âš ï¸ ì „í™” ë°œì‹  í”„ë¡œì„¸ìŠ¤ ì¤‘ë‹¨");
      }
    } catch(error) {
      // ì˜ˆìƒì¹˜ ëª»í•œ ì—ëŸ¬ë§Œ ì²˜ë¦¬ (ë„¤íŠ¸ì›Œí¬ ëŠê¹€ì€ callRealAPI ë‚´ë¶€ì—ì„œ ì´ë¯¸ ì²˜ë¦¬ë¨)
      pushLog(`âš ï¸ ì˜ˆìƒì¹˜ ëª»í•œ ì—ëŸ¬: ${error.message}`);
    }
    
    await sleep(400);
    setStepStatus(4,"done");
    
    // 5 - í˜¸ì „í™˜ ê¸°ë¡ í™•ì¸ (ì „í™” ì—°ê²° ì„±ê³µ ì‹œì—ë§Œ)
    setStepStatus(5,"active");
    
    // ì „í™”ê°€ ìµœì†Œ 1ë²ˆì´ë¼ë„ ì„±ê³µí–ˆì„ ë•Œë§Œ í˜¸ì „í™˜ ê¸°ë¡ í™•ì¸
    if(callSuccess && apiResult && apiResult.callSid) {
      pushLog("í˜¸ì „í™˜ ê¸°ë¡ í™•ì¸ ì¤‘... (í†µí™” ì™„ë£Œ ëŒ€ê¸°)");
      await sleep(10000);  // 10ì´ˆ ëŒ€ê¸°
      
      // í˜¸ì „í™˜ ê¸°ë¡ ì¡°íšŒ
      try {
        const url = `${API_BASE_URL}/simulator/transfer-log/${apiResult.callSid}`;
        const transferLog = await fetch(url);
        const logData = await transferLog.json();
        
        if(logData.found && logData.transferred) {
          pushLog(`âœ… í˜¸ì „í™˜ ê¸°ë¡ ë°œê²¬!`);
          pushLog(`ğŸ“ ìƒí™©ê·¼ë¬´ì(010-8672-1718)ì™€ ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤.`);
          pushLog(`   í˜¸ì „í™˜ ì‹œê°: ${logData.timestamp ? new Date(logData.timestamp).toLocaleTimeString('ko-KR') : 'í™•ì¸ ë¶ˆê°€'}`);
        } else {
          pushLog(`â„¹ï¸ í˜¸ì „í™˜ ê¸°ë¡ ì—†ìŒ (1ë²ˆì„ ëˆ„ë¥´ì§€ ì•ŠìŒ)`);
        }
      } catch(e) {
        pushLog(`âš ï¸ í˜¸ì „í™˜ ê¸°ë¡ ì¡°íšŒ ì‹¤íŒ¨: ${e.message}`);
      }
    } else {
      // ì „í™” ì—°ê²° ì‹¤íŒ¨ ì‹œ ìŠ¤í‚µ
      pushLog(`â„¹ï¸ í˜¸ì „í™˜ ê¸°ë¡ í™•ì¸ ê±´ë„ˆëœ€ (ì „í™” ì—°ê²° ì‹¤íŒ¨)`);
    }
    await sleep(400);
    setStepStatus(5,"done");
    
    // 6 - Reporting
    setStepStatus(6,"active"); 
    pushLog("Reporting ì €ì¥ ì™„ë£Œ - ì¥ì•  ì•Œë¦¼ ì´ë ¥ ê¸°ë¡");
    await sleep(400);
    setStepStatus(6,"done");

    // 7 - END
    setStepStatus(7,"active"); 
    pushLog("ê¸´ê¸‰ ì•Œë¦¼ ì›Œí¬í”Œë¡œìš° ì¢…ë£Œ");
    await sleep(300);
    
    // ì‹¤ì œ ê²½ê³¼ ì‹œê°„ ê³„ì‚°
    const elapsedTime = ((Date.now() - startTime) / 1000).toFixed(1);
    pushLog(`ì´ ì²˜ë¦¬ ì‹œê°„: ${elapsedTime}ì´ˆ`);
    
    await sleep(300);
    setStepStatus(7,"done");
    running = false;
  }

  // wire events
  $reset.onclick = ()=> reset();
  $start.onclick = ()=> runEmergency();

  // first render
  renderSteps();
})();
</script>
</body>
</html>

