<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5, user-scalable=yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <title>긴급 전화 알림 체험 | 솔리아 Sol-Knight</title>
  <style>
    :root{
      --bg: #f0f7ff;
      --card: #ffffff;
      --ink: #0f172a;
      --muted:#475569;
      --primary:#0046ff;
      --primary-2:#0033cc;
      --accent:#22c55e;
      --border:#d1e3f8;
      --warning:#ef4444;
      --warning-bg:#fff5f5;
      --warning-border:#fecaca;
      --shinhan-blue:#0046ff;
      --shinhan-light:#e6f0ff;
    }
    *{box-sizing:border-box}
    html,body{height:100%;-webkit-text-size-adjust:100%}
    body{margin:0;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Apple Color Emoji,Noto Color Emoji; color:var(--ink);overflow-x:hidden;min-height:100vh;padding:12px}
    .container{max-width:1100px;margin:0 auto;padding:24px 16px;background:#ffffff;border-radius:16px;box-shadow:0 10px 40px rgba(0,0,0,0.15)}
    h1{margin:0;font-size:24px;color:var(--shinhan-blue)}
    .sub{color:var(--muted);font-size:13px;margin-top:6px}
    .brand{display:inline-block;padding:8px 16px;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:#fff;border-radius:20px;font-size:12px;font-weight:700;letter-spacing:1px;margin-bottom:20px}
    
    @media(min-width:768px){
      body{padding:20px}
      .container{padding:40px}
      h1{font-size:28px}
      .sub{font-size:14px}
    }
    
    /* Alert Box */
    .alert-box{
      background:linear-gradient(135deg, #e6f0ff 0%, #f0f7ff 100%);
      border:2px solid var(--shinhan-blue);
      border-radius:12px;
      padding:16px;
      margin:16px 0;
      box-shadow:0 4px 12px rgba(0,70,255,0.1);
    }
    .alert-box h2{
      margin:0 0 10px;
      font-size:16px;
      color:var(--shinhan-blue);
      display:flex;
      align-items:center;
      gap:8px;
      font-weight:700;
    }
    .alert-box p{
      margin:6px 0;
      line-height:1.5;
      font-size:14px;
    }
    .alert-box .note{
      font-size:11px;
      color:var(--shinhan-blue);
      font-weight:600;
      margin-top:10px;
      background:#fff;
      padding:8px 10px;
      border-radius:8px;
      border-left:3px solid var(--shinhan-blue);
      line-height:1.5;
    }
    
    @media(min-width:768px){
      .alert-box{
        border-radius:16px;
        padding:20px;
        margin:24px 0;
      }
      .alert-box h2{
        font-size:18px;
        margin-bottom:12px;
      }
      .alert-box p{
        margin:8px 0;
        line-height:1.6;
      }
      .alert-box .note{
        font-size:12px;
        padding:8px 12px;
        margin-top:12px;
      }
    }
    
    /* User Input Form */
    .user-form{
      background:rgba(255,255,255,.9);
      backdrop-filter:saturate(120%) blur(2px);
      border:1px solid var(--border);
      border-radius:16px;
      padding:16px;
      margin:16px 0;
    }
    .user-form h3{
      margin:0 0 12px;
      font-size:15px;
    }
    .form-group{
      margin-bottom:14px;
    }
    .form-group label{
      display:block;
      font-size:13px;
      font-weight:600;
      margin-bottom:6px;
      color:var(--ink);
    }
    .form-group input{
      width:100%;
      padding:14px 16px;
      border:1px solid var(--border);
      border-radius:10px;
      font-size:16px;
      font-family:inherit;
      -webkit-appearance:none;
      appearance:none;
    }
    .form-group input:focus{
      outline:none;
      border-color:var(--primary);
      box-shadow:0 0 0 3px rgba(79,70,229,0.1);
    }
    .form-group .hint{
      font-size:11px;
      color:var(--muted);
      margin-top:4px;
      line-height:1.4;
    }
    
    @media(min-width:768px){
      .user-form{
        border-radius:22px;
        padding:24px;
        margin:24px 0;
      }
      .user-form h3{
        font-size:16px;
        margin-bottom:16px;
      }
      .form-group{
        margin-bottom:16px;
      }
      .form-group label{
        font-size:14px;
      }
      .form-group input{
        padding:10px 14px;
        font-size:14px;
        border-radius:12px;
      }
      .form-group .hint{
        font-size:12px;
      }
    }
    
    .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:16px}
    .btn{
      border:1px solid var(--border);
      background:#fff;
      padding:14px 20px;
      border-radius:10px;
      font-size:15px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      font-weight:600;
      min-height:48px;
      flex:1;
      white-space:nowrap;
      -webkit-tap-highlight-color:transparent;
    }
    .btn.primary{
      background:var(--primary);
      color:#fff;
      border-color:var(--primary);
      box-shadow:0 2px 8px rgba(0,70,255,0.2);
    }
    .btn.primary:active{background:var(--primary-2)}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    select{
      padding:12px 14px;
      border-radius:10px;
      border:1px solid var(--border);
      font-size:14px;
      background:#fff;
      min-height:48px;
      -webkit-appearance:none;
      appearance:none;
    }
    
    @media(min-width:768px){
      .controls{gap:12px}
      .btn{
        padding:10px 16px;
        border-radius:12px;
        font-size:14px;
        min-height:auto;
        flex:initial;
      }
      .btn.primary{box-shadow:none}
      .btn.primary:hover{background:var(--primary-2)}
      select{
        padding:8px 12px;
        border-radius:12px;
        min-height:auto;
      }
    }
    
    .grid{display:grid;grid-template-columns:1fr;gap:12px;margin-top:16px}
    @media(min-width:960px){.grid{grid-template-columns:1fr 1fr;gap:16px;margin-top:20px}}
    
    .panel{
      background:rgba(255,255,255,.8);
      backdrop-filter:saturate(120%) blur(2px);
      border:1px solid var(--border);
      border-radius:16px;
      padding:14px;
    }
    .panel h3{
      margin:0 0 10px;
      font-size:15px;
      display:flex;
      align-items:center;
      gap:6px;
    }
    
    @media(min-width:768px){
      .panel{
        border-radius:22px;
        padding:18px;
      }
      .panel h3{
        font-size:16px;
        margin-bottom:12px;
        gap:8px;
      }
    }
    
    .steps{
      display:flex;
      flex-direction:column;
      gap:6px;
      max-height:400px;
      overflow-y:auto;
      overflow-x:hidden;
      padding:2px;
      -webkit-overflow-scrolling:touch;
      scroll-behavior:smooth;
    }
    
    /* 스크롤바 스타일 */
    .steps::-webkit-scrollbar{
      width:6px;
    }
    .steps::-webkit-scrollbar-track{
      background:rgba(0,0,0,0.05);
      border-radius:10px;
    }
    .steps::-webkit-scrollbar-thumb{
      background:rgba(0,70,255,0.3);
      border-radius:10px;
    }
    .steps::-webkit-scrollbar-thumb:hover{
      background:rgba(0,70,255,0.5);
    }
    .step{
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px 12px;
      display:flex;
      align-items:flex-start;
      gap:10px;
      background:#fff;
      position:relative;
    }
    .step.active{background:linear-gradient(90deg,#e6f0ff,#f0f7ff);border-color:#0046ff;box-shadow:0 2px 8px rgba(0,70,255,0.12)}
    .step.done{background:linear-gradient(90deg,#ecfdf5,#f0fdf4);border-color:#6ee7b7}
    .step.skipped{opacity:.6}
    .dot{width:16px;height:16px;border-radius:50%;background:#cbd5e1;flex:0 0 auto;margin-top:2px}
    .step.active .dot{background:#0046ff;animation:pulse 1s infinite}
    .step.done .dot{background:#22c55e}
    @keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.15)}100%{transform:scale(1)}}
    .title{font-weight:600;font-size:13px;line-height:1.4}
    .subtxt{font-size:11px;color:var(--muted);margin-top:4px;line-height:1.3}
    .divider{width:2px;height:12px;background:linear-gradient(#e2e8f0,transparent);margin:4px auto}
    
    @media(min-width:768px){
      .steps{
        gap:8px;
        max-height:500px;
      }
      .step{
        border-radius:18px;
        padding:12px 14px;
        gap:12px;
      }
      .step.active{box-shadow:0 4px 10px rgba(0,70,255,0.12)}
      .dot{width:18px;height:18px}
      .title{font-size:14px}
      .subtxt{font-size:12px}
      .divider{height:16px;margin:8px auto}
    }
    
    .logs{
      background:#001a4d;
      color:#e5e7eb;
      border-radius:12px;
      border:2px solid #0046ff;
      height:300px;
      overflow:auto;
      padding:12px;
      font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size:11px;
      white-space:pre-wrap;
      line-height:1.5;
      -webkit-overflow-scrolling:touch;
    }
    
    @media(min-width:768px){
      .logs{
        border-radius:18px;
        height:450px;
        padding:14px;
        font-size:12px;
      }
    }
    
    @media(min-width:960px){
      .logs{height:540px}
    }
    
    .logline{line-height:1.6}
    .logtag{color:#6bb3ff}
    .muted{color:var(--muted);font-size:11px}
    footer{margin:20px 0 16px;text-align:center;color:#94a3b8;font-size:11px;line-height:1.5}
    .desktop-footer{display:none}
    .mobile-footer{display:block}
    .icon{width:16px;height:16px}
    .error-msg{color:#ef4444;font-size:12px;margin-top:8px;display:none;line-height:1.4}
    
    @media(min-width:768px){
      .muted{font-size:12px}
      footer{margin:28px 0;font-size:12px}
      .desktop-footer{display:block}
      .mobile-footer{display:none}
      .icon{width:18px;height:18px}
      .error-msg{font-size:13px}
    }
  </style>
</head>
<body>
  <div class="container">
    <span class="brand">SHINHAN DS · 뱅킹인프라본부</span>
    <h1>긴급 전화 알림 체험 <a href="/static/index.html" style="font-size:13px;color:#94a3b8;text-decoration:none;margin-left:8px;">← 메인</a></h1>
    <p style="font-size:14px;color:#94a3b8;margin:8px 0 20px 0;">Sol-Knight · Critical 장애 발생 시 즉시 전화 발신</p>

    <div class="alert-box">
      <h2>
        <svg class="icon" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
        </svg>
        시뮬레이션 안내
      </h2>
      
      <div style="background:#fef2f2;border-left:4px solid #ef4444;padding:12px;margin:12px 0;border-radius:4px;">
        <p style="margin:0;font-size:13px;color:#991b1b;"><strong>📞 실제 전화가 발신됩니다.</strong> 해외 번호(+1507...)로 오니 꼭 받아주세요.</p>
      </div>
      
      <div style="background:#eff6ff;border-left:4px solid #3b82f6;padding:12px;margin:12px 0;border-radius:4px;">
        <p style="margin:0 0 8px 0;font-size:13px;color:#1e40af;"><strong>💡 동작 방식</strong></p>
        <p style="margin:0;font-size:12px;color:#1e40af;line-height:1.6;">
          • 정담당자 + 부담당자: 각 2회씩 전화 (정 → 부 → 정 → 부)<br>
          • 정담당자만: 2회 전화 (정 → 정)<br>
          • 한 명이라도 받으면 즉시 종료<br>
          • 통화 중 <strong>키패드 1번</strong>: 상황근무자와 연결<br>
          • 통화 중 <strong>키패드 2번</strong>: 장애 문자(SMS) 수신
        </p>
      </div>
      
      <div style="background:#f8fafc;border-left:4px solid #64748b;padding:12px;margin:12px 0;border-radius:4px;">
        <p style="margin:0;font-size:13px;color:#334155;"><strong>✏️ 사용 방법</strong></p>
        <p style="margin:4px 0 0 0;font-size:12px;color:#475569;line-height:1.6;">
          아래에서 담당자 정보와 장애 메시지를 입력하고 시뮬레이션을 시작하세요.
        </p>
      </div>
    </div>

    <div class="user-form">
      <h3>정보 입력</h3>
      
      <div style="background:#ffffff;border:1px solid #e2e8f0;border-radius:8px;padding:16px;margin-bottom:12px;">
        <h4 style="margin:0 0 12px;font-size:14px;color:#0f172a;font-weight:600;">정담당자</h4>
        <div class="form-group" style="margin-bottom:12px">
          <label for="primaryName">성명</label>
          <input type="text" id="primaryName" placeholder="홍길동" />
        </div>
        <div class="form-group" style="margin-bottom:0">
          <label for="primaryPhone">휴대폰 번호</label>
          <input type="tel" id="primaryPhone" placeholder="01012345678" maxlength="13" class="phone-input" />
        </div>
      </div>
      
      <div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;padding:16px;margin-bottom:12px;">
        <h4 style="margin:0 0 12px;font-size:14px;color:#64748b;font-weight:600;">부담당자 <span style="font-size:12px;font-weight:400;">(선택)</span></h4>
        <div class="form-group" style="margin-bottom:12px">
          <label for="secondaryName">성명</label>
          <input type="text" id="secondaryName" placeholder="선택사항" />
        </div>
        <div class="form-group" style="margin-bottom:0">
          <label for="secondaryPhone">휴대폰 번호</label>
          <input type="tel" id="secondaryPhone" placeholder="선택사항" maxlength="13" class="phone-input" />
        </div>
      </div>
      
      <div style="background:#ffffff;border:1px solid #e2e8f0;border-radius:8px;padding:16px;margin-bottom:16px;">
        <h4 style="margin:0 0 4px;font-size:14px;color:#0f172a;font-weight:600;">장애 메시지</h4>
        <p style="margin:0 0 12px 0;font-size:12px;color:#94a3b8;">기본값: 단위DB 서버 다운 Critical</p>
        <div class="form-group" style="margin-bottom:0">
          <input type="text" id="incidentMessage" value="단위DB 서버 다운 Critical" />
        </div>
        
        <div style="background:#f0fdf4;border-left:4px solid #22c55e;padding:12px;margin-top:16px;border-radius:8px;">
          <p style="margin:0;font-size:12px;color:#166534;line-height:1.6;">
            <strong>✅ 체험 안내:</strong> 업무영향도 및 체험시간 단축을 위해 실제 상황근무자 호전환 연결은 막아두었습니다. (구현 검증 완료)
          </p>
        </div>
      </div>
      
      <div class="error-msg" id="errorMsg">정담당자 정보를 입력해주세요.</div>
    </div>

    <div class="controls">
      <button id="reset" class="btn">↻ 리셋</button>
      <button id="start" class="btn primary">▶ 시뮬레이션 시작</button>
    </div>

    <div class="grid">
      <div class="panel">
        <h3>긴급 전파 워크플로우</h3>
        <div id="steps" class="steps"></div>
      </div>

      <div class="panel">
        <h3>실시간 시뮬레이션 로그</h3>
        <div id="logs" class="logs"><div class="muted">시뮬레이션 로그가 여기에 출력됩니다…</div></div>
      </div>
    </div>

    <footer>
      <div class="desktop-footer">© <span id="year"></span> SHINHAN DS · 긴급 전화 알림 체험 (Sol-Knight)</div>
      <div class="mobile-footer">© <span id="year2"></span> SHINHAN DS<br>긴급 전화 알림 체험</div>
    </footer>
  </div>

<script>
(function(){
  const $ = (sel)=>document.querySelector(sel);
  const $$ = (sel)=>Array.from(document.querySelectorAll(sel));
  const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));

  const API_BASE_URL = window.location.origin;  // 동적으로 현재 서버 사용

  const STEPS_EMERGENCY = [
    { title:"START: 이벤트 수신 (NMS Webhook)"},
    { title:"분석 (Dify/LLM): 시스템명·장애내용 추출 및 긴급성 재판단"},
    { title:"조건 확인: 전화 발송 대상인가?"},
    { title:"ITSM 연동: 온콜 담당자 조회"},
    { title:"PDS/TTS 연동: 개인화 음성 통보"},
    { title:"Reporting: 결과 기록"},
    { title:"END"}
  ];

  let running = false;
  let lines = [];
  let realCallMode = true;  // 실제 전화 모드
  let startTime = null;  // 시뮬레이션 시작 시간

  const $steps = $("#steps");
  const $logs = $("#logs");
  const $start = $("#start");
  const $reset = $("#reset");
  const $primaryName = $("#primaryName");
  const $primaryPhone = $("#primaryPhone");
  const $secondaryName = $("#secondaryName");
  const $secondaryPhone = $("#secondaryPhone");
  const $incidentMessage = $("#incidentMessage");
  const $errorMsg = $("#errorMsg");

  // init
  const currentYear = new Date().getFullYear();
  $("#year").textContent = currentYear;
  if($("#year2")) $("#year2").textContent = currentYear;

  // Phone number formatting for all phone inputs
  function formatPhoneNumber(e){
    let val = e.target.value.replace(/[^0-9]/g, '');
    if(val.length <= 3) {
      e.target.value = val;
    } else if(val.length <= 7) {
      e.target.value = val.slice(0,3) + '-' + val.slice(3);
    } else if(val.length <= 11) {
      e.target.value = val.slice(0,3) + '-' + val.slice(3,7) + '-' + val.slice(7);
    } else {
      e.target.value = val.slice(0,3) + '-' + val.slice(3,7) + '-' + val.slice(7,11);
    }
  }
  
  $$('.phone-input').forEach(input => {
    input.oninput = formatPhoneNumber;
  });

  function renderSteps(){
    $steps.innerHTML = "";
    STEPS_EMERGENCY.forEach((s,i)=>{
      const el = document.createElement("div");
      el.className = "step";
      el.innerHTML = `<div class="dot"></div>
        <div><div class="title">${i+1}. ${s.title}</div>
        ${s.subtitle?`<div class="subtxt">${s.subtitle}</div>`:""}</div>`;
      $steps.appendChild(el);
      if(i<STEPS_EMERGENCY.length-1){ 
        const div = document.createElement("div"); 
        div.className="divider"; 
        $steps.appendChild(div); 
      }
    });
  }

  function setStepStatus(idx, status){
    const stepEls = $$(".step");
    const el = stepEls[idx];
    if(!el) return;
    el.classList.remove("idle","active","done","skipped");
    el.classList.add(status);
    
    // 활성화된 단계로 스크롤 (부드럽게)
    if(status === "active"){
      // 모바일에서는 더 부드럽게, 데스크톱에서는 즉시
      const isMobile = window.innerWidth < 768;
      setTimeout(() => {
        el.scrollIntoView({ 
          behavior: 'smooth', 
          block: isMobile ? 'center' : 'nearest',
          inline: 'nearest'
        });
      }, isMobile ? 100 : 50);
    }
  }

  function pushLog(text, timestamp){
    if(lines.length===0) $logs.innerHTML = "";
    lines.push(text);
    const div = document.createElement("div");
    div.className="logline";
    const timeStr = timestamp ? ` <span style="color:#94a3b8;font-size:11px">[${timestamp}]</span>` : '';
    div.innerHTML = `<span class="logtag">[Step ${lines.length}]</span> ${text}${timeStr}`;
    $logs.appendChild(div);
    $logs.scrollTop = $logs.scrollHeight;
  }

  function reset(){
    running = false; 
    lines = [];
    renderSteps();
    $logs.innerHTML = '<div class="muted">시뮬레이션 로그가 여기에 출력됩니다…</div>';
    $errorMsg.style.display = 'none';
    
    // 워크플로우를 맨 위로 스크롤
    if($steps){
      $steps.scrollTop = 0;
    }
  }

  function validateInputs(){
    const primaryName = $primaryName.value.trim();
    const primaryPhone = $primaryPhone.value.trim();
    const secondaryName = $secondaryName.value.trim();
    const secondaryPhone = $secondaryPhone.value.trim();
    const phoneRegex = /^010-\d{4}-\d{4}$/;
    
    // 정담당자는 필수
    if(!primaryName || !primaryPhone){
      $errorMsg.textContent = '정담당자 정보를 입력해주세요.';
      $errorMsg.style.display = 'block';
      return false;
    }
    
    if(!phoneRegex.test(primaryPhone)){
      $errorMsg.textContent = '정담당자 휴대폰 번호 형식이 올바르지 않습니다. (예: 010-1234-5678)';
      $errorMsg.style.display = 'block';
      return false;
    }
    
    // 부담당자는 선택사항이지만, 입력했다면 유효성 검사
    if(secondaryName || secondaryPhone){
      if(!secondaryName || !secondaryPhone){
        $errorMsg.textContent = '부담당자 정보를 입력하려면 성명과 휴대폰 번호를 모두 입력해주세요.';
        $errorMsg.style.display = 'block';
        return false;
      }
      
      if(!phoneRegex.test(secondaryPhone)){
        $errorMsg.textContent = '부담당자 휴대폰 번호 형식이 올바르지 않습니다. (예: 010-1234-5678)';
        $errorMsg.style.display = 'block';
        return false;
      }
      
      if(primaryPhone === secondaryPhone){
        $errorMsg.textContent = '정담당자와 부담당자의 휴대폰 번호가 동일합니다. 다른 번호를 입력해주세요.';
        $errorMsg.style.display = 'block';
        return false;
      }
    }
    
    $errorMsg.style.display = 'none';
    return true;
  }

  // 전화번호 형식 변환 (010-1234-5678 → +821012345678)
  function convertToE164(phone) {
    if(!phone) return null;
    // 010-1234-5678 → +821012345678
    return '+82' + phone.replace(/^0/, '').replace(/-/g, '');
  }

  // 로그 라인을 업데이트 (기존 라인 수정)
  function updateLastLog(text, timestamp){
    const logLines = $$(".logline");
    if(logLines.length > 0){
      const lastLine = logLines[logLines.length - 1];
      const currentStepNumber = lines.length;
      const timeStr = timestamp ? ` <span style="color:#94a3b8;font-size:11px">[${timestamp}]</span>` : '';
      lastLine.innerHTML = `<span class="logtag">[Step ${currentStepNumber}]</span> ${text}${timeStr}`;
      // lines 배열의 마지막 항목도 업데이트
      lines[lines.length - 1] = text;
    }
  }

      async function callRealAPI(primaryName, primaryPhone, secondaryName, secondaryPhone, incidentMessage){
    return new Promise((resolve, reject) => {
      try {
        const payload = {
          primary_name: primaryName,
          primary_phone: convertToE164(primaryPhone),
          secondary_name: secondaryName || null,
          secondary_phone: secondaryPhone ? convertToE164(secondaryPhone) : null,
          incident_summary: incidentMessage,
          tts_text: `긴급 상황입니다. ${incidentMessage} 장애가 발생했습니다.`
        };
        
        // "API 연결 중..." 로그 제거 (요청사항 4번)
        
        const eventSource = new EventSource(`${API_BASE_URL}/simulator/call`);
        let callResults = [];
        let completed = false;
        const callSidRef = { value: null };  // CallSid를 저장할 객체 (참조 전달용)
        
        // POST 데이터를 전송하기 위해 fetch 사용
        fetch(`${API_BASE_URL}/simulator/call`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'text/event-stream'
          },
          body: JSON.stringify(payload)
        }).then(response => {
          if(!response.ok){
            throw new Error(`API 오류: ${response.status}`);
          }
          
          const reader = response.body.getReader();
          const decoder = new TextDecoder();
          
          function readStream(){
            reader.read().then(({done, value}) => {
              if(done){
                if(!completed){
                  pushLog("🔔 전화 발신 프로세스 완료");
                  resolve({success: true, calls: callResults});
                }
                return;
              }
              
              const text = decoder.decode(value);
              const lines = text.split('\n');
              
              for(const line of lines){
                if(line.startsWith('data: ')){
                  try {
                    const data = JSON.parse(line.substring(6));
                    handleSSEEvent(data, callResults, callSidRef);
                    
                    if(data.type === 'escalation_complete' || data.type === 'escalation_failed'){
                      completed = true;
                      // escalation_complete는 성공, escalation_failed는 실패
                      const isSuccess = data.type === 'escalation_complete';
                      resolve({success: isSuccess, calls: callResults, callSid: callSidRef.value});
                      return;
                    }
                  } catch(e){
                    console.error('SSE parse error:', e);
                  }
                }
              }
              
            readStream();
          }).catch(async error => {
            // 네트워크 끊김 감지 (전화 수신 중)
            if(!completed){
              // 모바일에서 전화를 받으면 네트워크가 전환되어 브라우저 연결이 끊김
              // 통화가 끝날 때까지 대기 (약 30초)
              pushLog(`📞 통화 중입니다...`);
              
              // 30초 대기 후 성공 처리
              await new Promise(r => setTimeout(r, 30000));
              
              if(!completed){
                completed = true;
                pushLog(`✅ 전화 연결 성공!`);
                resolve({success: true, calls: callResults, answered: true, callSid: callSidRef.value});
              }
            }
          });
          }
          
          readStream();
        }).catch(async error => {
          // 전화 수신으로 인한 연결 끊김인 경우
          if(error.message.includes('Failed to fetch') || error.message.includes('NetworkError')){
            // 통화가 끝날 때까지 대기 (약 30초)
            pushLog(`📞 통화 중입니다...`);
            
            // 30초 대기 후 성공 처리
            await new Promise(r => setTimeout(r, 30000));
            
            pushLog(`✅ 전화 연결 성공!`);
            resolve({success: true, calls: [], answered: true, callSid: callSidRef.value});
          } else {
            pushLog(`⚠️ API 호출 실패: ${error.message}`);
            pushLog(`💡 서버가 실행 중인지 확인해주세요: ${API_BASE_URL}`);
            reject(error);
          }
        });
        
      } catch(error) {
        pushLog(`⚠️ 오류 발생: ${error.message}`);
        reject(error);
      }
    });
  }

  function handleSSEEvent(data, callResults, callSidRef){
    switch(data.type){
      case 'call_start':
        pushLog(`📞 ${data.role} ${data.name} (${data.phone}): 발신중...`, data.timestamp);
        break;
      
      case 'call_initiated':
        updateLastLog(`📞 ${data.role || '담당자'}: 호출 시작 (Call ID: ${data.call_id})`, data.timestamp);
        // CallSid 저장
        if(callSidRef && data.call_id) {
          callSidRef.value = data.call_id;
          console.log('[DEBUG] CallSid saved:', data.call_id);
        }
        break;
      
      case 'call_answered':
        updateLastLog(`✅ ${data.name}: 전화 연결 성공! (통화시간: ${data.duration}초)`, data.timestamp);
        callResults.push({name: data.name, status: 'answered', duration: data.duration});
        break;
      
      case 'call_failed':
        updateLastLog(`❌ ${data.name}: 전화 연결 실패 (${data.reason})`, data.timestamp);
        callResults.push({name: data.name, status: 'failed', reason: data.reason});
        break;
      
      case 'call_error':
        updateLastLog(`⚠️ ${data.name}: 오류 발생 - ${data.error}`, data.timestamp);
        callResults.push({name: data.name, status: 'error', error: data.error});
        break;
      
      case 'escalation_complete':
        pushLog(`🎉 에스컬레이션 성공: ${data.answered_by}님이 전화를 받았습니다.`, data.timestamp);
        pushLog(`   총 시도 횟수: ${data.total_attempts}회`);
        break;
      
      case 'escalation_failed':
        pushLog(`⚠️ 에스컬레이션 실패: 모든 담당자가 전화를 받지 않았습니다.`, data.timestamp);
        pushLog(`   총 시도 횟수: ${data.total_attempts}회`);
        break;
      
      case 'error':
        pushLog(`⚠️ 시스템 오류: ${data.message}`, data.timestamp);
        break;
    }
  }

  async function runEmergency(){
    if(running) return;
    
    if(!validateInputs()) return;
    
    reset(); 
    running = true;
    startTime = Date.now();  // 시작 시간 기록
    
    // 모바일에서 워크플로우 섹션으로 부드럽게 스크롤
    const isMobile = window.innerWidth < 768;
    if(isMobile){
      const gridSection = document.querySelector('.grid');
      if(gridSection){
        setTimeout(() => {
          gridSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 300);
      }
    }
    
    const primaryName = $primaryName.value.trim();
    const primaryPhone = $primaryPhone.value.trim();
    const secondaryName = $secondaryName.value.trim();
    const secondaryPhone = $secondaryPhone.value.trim();
    const incidentMessage = $incidentMessage.value.trim() || "단위DB 서버 다운 Critical";

    // 0
    setStepStatus(0,"active");
    pushLog(`NMS Webhook 수신 → 등급: Critical | 내용: '${incidentMessage}'`);
    await sleep(400);
    setStepStatus(0,"done");

    // 1
    setStepStatus(1,"active");
    pushLog("AI 비서(Dify/LLM) 분석 시작…");
    await sleep(300);
    pushLog("• 시스템명 추출: 단위DB 서버");
    await sleep(300);
    pushLog("• 핵심 장애 내용: 서버 다운");
    await sleep(300);
    pushLog(`• 원 등급: Critical (표준)`);
    await sleep(300);
    pushLog(`• 긴급성 재판단: 전화 발송 필요 (Critical 등급)`);
    await sleep(400);
    setStepStatus(1,"done");

    // 2
    setStepStatus(2,"active");
    pushLog(`조건 확인: 전화 발송 대상 → YES (긴급 전화 경로 선택)`);
    await sleep(400);
    setStepStatus(2,"done");

    // 3
    setStepStatus(3,"active"); 
    pushLog(`ITSM 온콜 조회… 정담당자: ${primaryName} / ${primaryPhone}`);
    await sleep(300);
    if(secondaryName && secondaryPhone){
      pushLog(`ITSM 온콜 조회… 부담당자: ${secondaryName} / ${secondaryPhone}`);
      await sleep(300);
    } else {
      pushLog(`부담당자: 미지정 (정담당자만 알림 발송)`);
      await sleep(300);
    }
    setStepStatus(3,"done");
    
    // 4 - 실제 API 호출 (실시간 에스컬레이션)
    setStepStatus(4,"active"); 
    pushLog(`[실제 전화 발신] 순차 에스컬레이션 시작`);
    await sleep(300);
    
    let apiResult = null;
    let callSuccess = false;
    try {
      // SSE로 실시간 로그가 자동 출력됨
      // callRealAPI 내부에서 네트워크 끊김도 처리함
      apiResult = await callRealAPI(primaryName, primaryPhone, secondaryName, secondaryPhone, incidentMessage);
      
      if(apiResult && apiResult.success){
        callSuccess = true;
        await sleep(300);
      } else {
        pushLog("⚠️ 전화 발신 프로세스 중단");
      }
    } catch(error) {
      // 예상치 못한 에러만 처리 (네트워크 끊김은 callRealAPI 내부에서 이미 처리됨)
      pushLog(`⚠️ 예상치 못한 에러: ${error.message}`);
    }
    
    await sleep(400);
    setStepStatus(4,"done");
    
    // 통화 완료 후 충분한 대기 시간 (전화가 완전히 종료될 때까지)
    await sleep(8000);  // 8초 대기
    
    // 5 - Reporting (호전환 여부 확인 포함)
    setStepStatus(5,"active");
    
    // 호전환 및 SMS 기록 확인
    if(callSuccess && apiResult && apiResult.callSid) {
      await sleep(2000);  // 2초 대기 (기록 저장 시간 확보)
      
      // 호전환 및 SMS 기록 간단히 확인
      let smsStatus = "";
      try {
        const url = `${API_BASE_URL}/simulator/transfer-log/${apiResult.callSid}`;
        const transferLog = await fetch(url);
        const logData = await transferLog.json();
        
        if(logData.found) {
          if(logData.transferred) {
            smsStatus = " / 호전환: 연결 완료";
          } else if(logData.sms_sent) {
            smsStatus = " / 장애 문자 전송 완료";
          }
        }
      } catch(e) {
        // 로그 확인 실패는 무시
      }
      
      pushLog(`Reporting 저장 완료 - 장애 알림 이력 기록${smsStatus}`);
    } else {
      pushLog(`Reporting 저장 완료 - 장애 알림 이력 기록`);
    }
    
    await sleep(400);
    setStepStatus(5,"done");

    // 6 - END
    setStepStatus(6,"active"); 
    pushLog("긴급 알림 워크플로우 종료");
    await sleep(300);
    
    // 실제 경과 시간 계산
    const elapsedTime = ((Date.now() - startTime) / 1000).toFixed(1);
    pushLog(`총 처리 시간: ${elapsedTime}초`);
    
    await sleep(300);
    setStepStatus(6,"done");
    running = false;
  }

  // wire events
  $reset.onclick = ()=> reset();
  $start.onclick = ()=> runEmergency();

  // first render
  renderSteps();
})();
</script>
</body>
</html>

