# 순차적 에스컬레이션 로직

## 개요

시뮬레이터는 정담당자와 부담당자에게 **순차적**으로 전화를 발신합니다. 한 명이라도 전화를 받으면 즉시 종료되며, 아무도 받지 않으면 최대 4회까지 시도합니다.

## 에스컬레이션 순서

```
1차 시도: 정담당자
   ↓ (받지 않음)
2차 시도: 부담당자
   ↓ (받지 않음)
3차 시도: 정담당자 (2차)
   ↓ (받지 않음)
4차 시도: 부담당자 (2차)
   ↓
종료 (성공 또는 실패)
```

## 상세 동작

### 1. 정담당자 우선 발신

- 정담당자에게 먼저 전화
- 15초 타임아웃 설정
- 전화 상태 실시간 모니터링

### 2. 부담당자 에스컬레이션

정담당자가 **받지 않을 경우**:
- 부담당자에게 전화
- 동일한 메시지 전달
- 15초 타임아웃 설정

### 3. 2차 시도

1차 시도에서 둘 다 받지 않을 경우:
- 정담당자 → 부담당자 순으로 다시 1회씩 시도
- 총 4회 시도 (정-부-정-부)

### 4. 성공 조건

다음 중 **하나라도 해당**되면 성공:
- 정담당자가 전화를 받음
- 부담당자가 전화를 받음
- 어느 시도에서든 한 명이 받으면 **즉시 종료**

### 5. 실패 조건

다음 **모두** 해당될 경우 실패:
- 정담당자 2회 시도 모두 실패
- 부담당자 2회 시도 모두 실패
- 총 4회 시도 완료

## 통화 상태 판정

### Answered (성공)

- Twilio 통화 상태: `completed`
- 통화 시간 (`duration`) > 0초
- 사람이 전화를 받음

### No-answer (실패)

- Twilio 통화 상태: `completed`
- 통화 시간 (`duration`) = 0초
- 벨은 울렸지만 받지 않음

### Busy (실패)

- Twilio 통화 상태: `busy`
- 통화중 또는 전화 거부

### Failed (실패)

- Twilio 통화 상태: `failed`
- 잘못된 번호 또는 시스템 오류

### Timeout (실패)

- 15초 내에 응답 없음
- 자동으로 다음 담당자에게 에스컬레이션

## 실시간 로그 업데이트

### SSE (Server-Sent Events) 사용

백엔드에서 프론트엔드로 실시간 상태 전송:

1. **call_start**: 발신 시작
   ```
   📞 정담당자 홍길동 (010-1234-5678): 발신중...
   ```

2. **call_initiated**: 호출 시작
   ```
   📞 정담당자: 호출 시작 (Call ID: CAxxxxx)
   ```

3. **call_answered**: 성공
   ```
   ✅ 홍길동: 전화 연결 성공! (통화시간: 12초)
   ```

4. **call_failed**: 실패
   ```
   ❌ 홍길동: 전화 연결 실패 (no-answer)
   ```

5. **escalation_complete**: 에스컬레이션 성공
   ```
   🎉 에스컬레이션 성공: 홍길동님이 전화를 받았습니다.
      총 시도 횟수: 1회
   ```

6. **escalation_failed**: 에스컬레이션 실패
   ```
   ⚠️ 에스컬레이션 실패: 모든 담당자가 전화를 받지 않았습니다.
      총 시도 횟수: 4회
   ```

## 메시지 반복

- 전화 연결 시 메시지를 **2번 반복**하여 읽음
- TwiML 구조:
  ```xml
  <Say>메시지 내용</Say>
  <Pause length="1"/>
  <Say>메시지 내용</Say>  <!-- 2번째 반복 -->
  <Pause length="1"/>
  <Say>메시지 전달이 완료되었습니다. 감사합니다.</Say>
  <Hangup/>
  ```

## 부담당자 미지정 시

부담당자가 없는 경우:
- 정담당자만 2회 시도
- 순서: 정담당자 → 정담당자(2차)
- 총 2회 시도 후 종료

## 시간 설정

- **호출 타임아웃**: 15초 (`CALL_TIMEOUT_SECONDS`)
- **상태 확인 간격**: 1초
- **최대 대기 시간**: 30초
- **시도 간 대기**: 1초

## 비용 예상

Twilio 기준 (한국 발신):
- 통화당 비용: 약 $0.013/분
- 4회 시도 시: 약 $0.05 (약 65원)
- 1회 성공 시: 약 $0.013 (약 16원)

## 트러블슈팅

### 문제: 모든 시도가 실패

**원인**:
- 전화번호 형식 오류 (E.164 형식 필요)
- Twilio Trial 계정의 Verified Number 미등록
- 네트워크 문제

**해결**:
1. 전화번호가 `+821012345678` 형식인지 확인
2. Twilio 콘솔에서 Verified Caller IDs 확인
3. 네트워크 연결 상태 확인

### 문제: 실시간 로그가 업데이트되지 않음

**원인**:
- SSE 연결 실패
- 브라우저 호환성 문제

**해결**:
1. 브라우저 콘솔에서 에러 확인
2. 최신 브라우저 사용 (Chrome, Firefox, Edge)
3. CORS 설정 확인

### 문제: 에스컬레이션이 너무 느림

**원인**:
- Twilio 통화 상태 확인 지연
- 네트워크 지연

**해결**:
1. `max_wait` 값 조정 (기본 30초)
2. 네트워크 환경 개선
3. Twilio 리전 확인

## 참고

- [Twilio 통화 상태](https://www.twilio.com/docs/voice/api/call-resource#call-status-values)
- [Server-Sent Events (SSE)](https://developer.mozilla.org/en-US/docs/Web/API/Server-sent_events)
- [TwiML 문서](https://www.twilio.com/docs/voice/twiml)

